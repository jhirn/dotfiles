"use strict";var M=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var ge=Object.getOwnPropertyNames;var Pe=Object.prototype.hasOwnProperty;var ye=(e,t)=>{for(var o in t)M(e,o,{get:t[o],enumerable:!0})},Ne=(e,t,o,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let l of ge(t))!Pe.call(e,l)&&l!==o&&M(e,l,{get:()=>t[l],enumerable:!(i=he(t,l))||i.enumerable});return e};var Se=e=>Ne(M({},"__esModule",{value:!0}),e);var Fe={};ye(Fe,{default:()=>oe});module.exports=Se(Fe);var s=require("@raycast/api"),se=require("child_process");var be=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],Ce=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],we=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],Ie=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],R=(e,t,o)=>{let i=e;return typeof t=="string"||Array.isArray(t)?i=e.toLocaleString(t,o):(t===!0||o!==void 0)&&(i=e.toLocaleString(void 0,o)),i},K=e=>{if(typeof e=="number")return Math.log10(e);let t=e.toString(10);return t.length+Math.log10(`0.${t.slice(0,15)}`)},$e=e=>typeof e=="number"?Math.log(e):K(e)*Math.log(10),Ae=(e,t)=>{if(typeof e=="number")return e/t;let o=e/BigInt(t),i=e%BigInt(t);return Number(o)+Number(i)/t},v=(e,t)=>{if(t===void 0)return e;if(typeof t!="number"||!Number.isSafeInteger(t)||t<0)throw new TypeError(`Expected fixedWidth to be a non-negative integer, got ${typeof t}: ${t}`);return t===0?e:e.length<t?e.padStart(t," "):e},Te=e=>{let{minimumFractionDigits:t,maximumFractionDigits:o}=e;if(!(t===void 0&&o===void 0))return{...t!==void 0&&{minimumFractionDigits:t},...o!==void 0&&{maximumFractionDigits:o},roundingMode:"trunc"}};function E(e,t){if(typeof e!="bigint"&&!Number.isFinite(e))throw new TypeError(`Expected a finite number, got ${typeof e}: ${e}`);t={bits:!1,binary:!1,space:!0,nonBreakingSpace:!1,...t};let o=t.bits?t.binary?Ie:we:t.binary?Ce:be,i=t.space?t.nonBreakingSpace?"\xA0":" ":"",l=typeof e=="number"?e===0:e===0n;if(t.signed&&l){let h=` 0${i}${o[0]}`;return v(h,t.fixedWidth)}let P=e<0,a=P?"-":t.signed?"+":"";P&&(e=-e);let f=Te(t),C;if(e<1){let h=R(e,t.locale,f);C=a+h+i+o[0]}else{let h=Math.min(Math.floor(t.binary?$e(e)/Math.log(1024):K(e)/3),o.length-1);if(e=Ae(e,(t.binary?1024:1e3)**h),!f){let x=Math.max(3,Math.floor(e).toString().length);e=e.toPrecision(x)}let T=R(Number(e),t.locale,f),B=o[h];C=a+T+i+B}return v(C,t.fixedWidth)}var b=require("react");var $=require("react"),Be=()=>{};function xe(e,t){let o=(0,$.useRef)(Be);(0,$.useEffect)(()=>{o.current=e},[e]),(0,$.useEffect)(()=>{if(o.current(),(t??0)>0){let l=Math.max(t??0,1e3),P=setInterval(()=>o.current(),l);return()=>clearInterval(P)}},[t])}var U=xe;var O=process.platform,A=O==="darwin",m=O==="win32";function G(e){return Buffer.from(e,"utf16le").toString("base64")}var Me=`
$result = Get-Process | Where-Object { $_.Id -ne 0 } | ForEach-Object {
  [PSCustomObject]@{
    pid = $_.Id
    name = $_.ProcessName
    cpu = 0
    mem = [math]::Round($_.WorkingSet64 / 1KB, 0)
    path = if ($_.Path) { $_.Path } else { '' }
  }
}
$result | ConvertTo-Json -Compress
`,Ee=`
$cpuCores = (Get-CimInstance Win32_ComputerSystem).NumberOfLogicalProcessors
$processes = Get-CimInstance Win32_PerfFormattedData_PerfProc_Process | Where-Object { $_.IDProcess -ne 0 -and $_.Name -ne '_Total' -and $_.Name -ne 'Idle' }
$result = $processes | ForEach-Object {
  [PSCustomObject]@{
    pid = $_.IDProcess
    cpu = [math]::Round($_.PercentProcessorTime / $cpuCores, 1)
  }
}
$result | ConvertTo-Json -Compress
`;function j(){return m?`powershell -NoLogo -NoProfile -EncodedCommand ${G(Me)}`:"ps -eo pid,ppid,pcpu,rss,comm"}function Y(){return m?`powershell -NoLogo -NoProfile -EncodedCommand ${G(Ee)}`:"ps -eo pid,ppid,pcpu,rss,comm"}function z(e,t=!1){return m?t?`taskkill /F /PID ${e}`:`taskkill /PID ${e}`:t?`zsh -c 'sudo kill -9 ${e}'`:`kill -9 ${e}`}function Z(e){let t=e.trim();if(!t)return null;let o=t.match(/(\d+)\s+(\d+)\s+(\d+[.|,]\d+)\s+(\d+)\s+(.*)/);if(!o)return null;let[,i,l,P,a,f]=o;return{id:parseInt(i),pid:parseInt(l),cpu:parseFloat(P),mem:parseInt(a),path:f,processName:f.match(/[^/]*$/)?.[0]??""}}function H(e){try{let t=JSON.parse(e);return(Array.isArray(t)?t:[t]).map(i=>({id:i.pid,pid:0,cpu:i.cpu,mem:i.mem,path:i.path||"",processName:i.name||""}))}catch{return console.error("Failed to parse Windows process output"),[]}}function J(e){let t=new Map;try{let o=JSON.parse(e),i=Array.isArray(o)?o:[o];for(let l of i)l?.pid&&t.set(l.pid,l.cpu??0)}catch{console.error("Failed to parse Windows performance output")}return t}function q(e){if(A)return e.includes(".prefPane")?"prefPane":e.includes(".app/")?"app":"binary";if(m){let t=e.toLowerCase();return t.endsWith(".exe")&&(t.includes("program files")||t.includes("applications"))?"app":"binary"}return"binary"}function X(e,t){return A?e.match(/(?<=\/)[^/]+(?=\.app\/)/)?.[0]:m?t.replace(/\.exe$/i,""):t}function V(e){return A?e.type==="prefPane"?{fileIcon:e.path?.replace(/(.+\.prefPane)(.+)/,"$1")??""}:e.type==="app"||e.type==="aggregatedApp"?{fileIcon:e.path?.replace(/(.+\.app)(.+)/,"$1")??""}:"/System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/ExecutableBinaryIcon.icns":m?e.type==="app"?{fileIcon:e.path}:"\u{1F5A5}\uFE0F":"\u2699\uFE0F"}function Q(e){return A&&e?{title:"Failed to Force Kill Process",message:"Please ensure that touch ID/password prompt is enabled for sudo",helpUrl:"https://dev.to/siddhantkcode/enable-touch-id-authentication-for-sudo-on-macos-sonoma-14x-4d28"}:m&&e?{title:"Failed to Force Kill Process",message:"Administrative privileges may be required. Try running as administrator."}:{title:"Failed to Kill Process",message:"The process could not be terminated. It may have already exited or require elevated privileges."}}var F=require("child_process");var ee={maxBuffer:10*1024*1024};async function te(){return new Promise((e,t)=>{(0,F.exec)(j(),ee,(o,i)=>{if(o){t(o);return}let P=(m?H(i):i.split(`
`).map(Z).filter(Boolean)).filter(a=>a?.processName).map(a=>{let f=a.path||"",C=a.processName||"",h=q(f);return{id:a.id||0,pid:a.pid||0,cpu:a.cpu||0,mem:a.mem||0,type:h,path:f,processName:C,appName:h==="app"?X(f,C):void 0}}).filter(a=>a.processName!=="");e(P)})})}async function re(){return m?new Promise(e=>{(0,F.exec)(Y(),ee,(t,o)=>{if(t){console.error("Failed to fetch CPU performance data:",t),e(new Map);return}e(J(o))})}):new Map}var d=require("react/jsx-runtime");function oe(){let[e,t]=(0,b.useState)([]),[o,i]=(0,b.useState)([]),[l,P]=(0,b.useState)(""),a=(0,s.getPreferenceValues)(),f=a.shouldSearchInPaths,C=a.shouldSearchInPid,h=a.shouldPrioritizeAppsWhenFiltering,T=a.shouldShowPID,B=a.shouldShowPath,x=+a.refreshDuration,ne=a.closeWindowAfterKill,L=a.clearSearchBarAfterKill,ie=a.goToRootAfterKill,ae=a.skipConfirmation,[_,ce]=(0,b.useState)(a.sortByMem?"memory":"cpu"),[I,le]=(0,b.useState)(a.aggregateApps),[k,pe]=(0,b.useState)(new Map),D=()=>{te().then(r=>{m&&k.size>0&&(r=r.map(n=>{let c=k.get(n.id);return c!==void 0?{...n,cpu:c}:n})),t(r),m&&re().then(n=>{n.size>0&&(pe(n),t(c=>c.map(S=>{let y=n.get(S.id);return y!==void 0?{...S,cpu:y}:S})))})}).catch(r=>{console.error("Failed to fetch processes:",r),(0,s.showToast)({title:"Failed to fetch processes",style:s.Toast.Style.Failure,message:r instanceof Error?r.message:"Unknown error"})})};U(D,x),(0,b.useEffect)(()=>{let r=e;I&&(r=me(r)),r.sort((n,c)=>_==="memory"?n.mem>c.mem?-1:1:n.cpu>c.cpu?-1:1),i(r)},[e,_,I]);let ue=r=>V(r),W=async(r,n=!1)=>{let c=r.processName==="-"?`process ${r.id}?`:r.processName;if(!ae&&!await(0,s.confirmAlert)({title:`${n?"Force ":""}Kill ${c}?`,rememberUserChoice:!0})){(0,s.showToast)({title:`Cancelled Killing ${c}`,style:s.Toast.Style.Failure});return}let S=z(r.id,n);(0,se.exec)(S,y=>{if(y){let N=Q(n);n&&N.helpUrl?(0,s.confirmAlert)({title:N.title,message:N.message,primaryAction:{title:"Open Help",onAction:()=>(0,s.open)(N.helpUrl)}}):(0,s.showToast)({title:N.title,message:N.message,style:s.Toast.Style.Failure});return}(0,s.showToast)({title:`Killed ${c}`,style:s.Toast.Style.Success})}),t(o.filter(y=>y.id!==r.id)),ne&&(0,s.closeMainWindow)(),ie&&(0,s.popToRoot)({clearSearchBar:L}),L&&(0,s.clearSearchBar)({forceScrollToTop:!0})},de=r=>{let n=[];return r.type==="aggregatedApp"&&r.appName!=null&&n.push(r.appName),T&&n.push(r.id.toString()),B&&n.push(r.path),n.join(" - ")},me=r=>{let n=Array(),c=new Map;c.set(1,{process:{id:1},childNodes:[]});let S=Array();r.forEach(p=>{if(p.type==="app"){S.push(p.id);let g=c.get(p.id);g==null?(g={process:p,childNodes:[]},c.set(p.id,g)):g.process=p;let u=c.get(p.pid);if(u==null)u={process:void 0,childNodes:[g]},c.set(p.pid,u);else if(u.process==null)u.childNodes.push(g);else{let w;for(;u?.process!=null&&u.process.pid!==1&&(w=c.get(u.process.pid))!=null;)u=w;u?.childNodes.push(g)}u.process?.id!==1&&(u.childNodes=u.childNodes.concat(g.childNodes),g.childNodes=[])}else n.push(p)});let y=c.get(1)?.childNodes,N=Array();return y?.forEach(p=>{if(p.process==null)return;N.push(p.process.id);let g=p.childNodes.map(u=>u.process?.id).filter(u=>u!=null);N=N.concat(g),n.push({id:p.process.id,pid:p.process.pid,cpu:(p.childNodes?.reduce((u,w)=>u+(w.process?.cpu??0),0)??0)+p.process.cpu,mem:(p.childNodes?.reduce((u,w)=>u+(w.process?.mem??0),0)??0)+p.process.mem,type:"aggregatedApp",path:p.process.path,processName:p.process.processName,appName:p.process.path.match(/(?<=\/)[^/]+(?=\.app\/)/)?.[0]})}),n},fe=o.length;return(0,d.jsx)(s.List,{isLoading:o.length===0,searchBarPlaceholder:"Filter by name",onSearchTextChange:r=>P(r),searchBarAccessory:(0,d.jsx)(s.List.Dropdown,{tooltip:"Filter",storeValue:!0,onChange:r=>ce(r),children:(0,d.jsxs)(s.List.Dropdown.Section,{title:"Sort By",children:[(0,d.jsx)(s.List.Dropdown.Item,{title:"CPU Usage",value:"cpu"}),(0,d.jsx)(s.List.Dropdown.Item,{title:"Memory Usage",value:"memory"})]})}),children:(0,d.jsx)(s.List.Section,{title:"Processes",subtitle:`${fe} running`,children:o.filter(r=>{if(l==="")return!0;let n=r.processName.toLowerCase().includes(l.toLowerCase()),c=f&&r.path.toLowerCase().match(new RegExp(`.+${l}.*\\.[app|framework|prefpane]`,"ig"))!=null,S=C&&r.id.toString().includes(l),y=r.type==="aggregatedApp"&&r.appName?.toLowerCase().includes(l.toLowerCase());return n||c||S||y}).sort((r,n)=>{if(h){let c=["app","aggregatedApp"];if(c.includes(r.type)&&!c.includes(n.type))return-1;if(!c.includes(r.type)&&c.includes(n.type))return 1}return 0}).map((r,n)=>{let c=ue(r);return(0,d.jsx)(s.List.Item,{title:r.processName,subtitle:de(r),icon:c,accessories:[{text:`${r.cpu.toFixed(2)}%`,icon:{source:"cpu.svg",tintColor:s.Color.PrimaryText},tooltip:"% CPU"},{text:E(r.mem*1024),icon:{source:"memorychip.svg",tintColor:s.Color.PrimaryText},tooltip:"Memory"}],actions:(0,d.jsxs)(s.ActionPanel,{children:[(0,d.jsx)(s.Action,{title:"Kill",icon:s.Icon.XMarkCircle,onAction:()=>W(r)}),(0,d.jsx)(s.Action,{title:"Force Kill",icon:s.Icon.XMarkCircle,onAction:()=>W(r,!0)}),r.path==null?null:(0,d.jsx)(s.Action.CopyToClipboard,{title:"Copy Path",content:r.path,shortcut:s.Keyboard.Shortcut.Common.CopyPath}),(0,d.jsx)(s.Action,{title:"Reload",icon:s.Icon.ArrowClockwise,shortcut:s.Keyboard.Shortcut.Common.Refresh,onAction:()=>D()}),(0,d.jsx)(s.Action,{title:`${I?"Disable":"Enable"} Aggregating Apps`,icon:s.Icon.AppWindow,shortcut:{modifiers:["shift"],key:"tab"},onAction:()=>{le(!I),(0,s.showToast)({title:`${I?"Disabled":"Enabled"} aggregating apps`})}})]})},n)})})})}
